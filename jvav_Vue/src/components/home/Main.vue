<template>
  <div>
    <el-row :gutter="10">
      <el-col :span="15">
        <el-card style="width: 800px; height: 600px;">
          <el-input
            clearable
            style="width: 350px;"
            placeholder="请输入目标 url"
            v-model="url">
          </el-input>
          <div style="float: right;">
            <span>WebSocket: </span>
            <el-switch v-model="websocket" @change="mulWebSocket"></el-switch>
          </div>
          <el-divider></el-divider>


          <el-button type="primary" style="width: 144px;" icon="el-icon-check" @click="check">检测 key</el-button>
          <el-input
            disabled
            v-loading="loading"
            style="width: 530px; margin-left: 15px;"
            placeholder="有效的 key"
            suffix-icon="el-icon-key"
            v-model="validKey">
          </el-input>
          <el-button type="danger" icon="el-icon-bottom" circle style="float: right;" @click="key=validKey"></el-button>
          <el-divider></el-divider>

          <el-button type="primary" icon="el-icon-check" @click="checkGadget">检测 Gadgets</el-button>
          <el-select v-model="value2" multiple collapse-tags placeholder="选择要检测的 Gadgets"  style="width: 220px;margin-left: 10px;" @change='changeSelect'>
              <el-checkbox v-model="checked" @change='selectAll'>全选</el-checkbox>
              <el-option
                v-for="item in options"
                :key="item.value"
                :label="item.label"
                :value="item.value">
              </el-option>
          </el-select>
          <el-input
            clearable
            style="width: 300px; margin-left: 10px;"
            placeholder="请输入 key"
            suffix-icon="el-icon-key"
            v-model="key">
          </el-input>
          <el-button :disabled="isView" type="danger" icon="el-icon-view" circle style="float: right;" @click="dialogVisible=true"></el-button>
          <el-dialog
            title="可利用的 Gadgets:"
            :visible.sync="dialogVisible"
            width="30%"
            :before-close="handleClose">
            <ul>
              <li v-for="gadget in validGadgets">{{gadget}}</li>
            </ul>
            <span slot="footer" class="dialog-footer">
              <el-button type="primary" @click="dialogVisible = false">确 定</el-button>
            </span>
          </el-dialog>


          <el-divider></el-divider>
          <el-input class="input-with-select" clearable v-model="cmd" style="width: 470px; " placeholder="请输入命令 如:whoami">
            <el-select v-model="value1" multiple collapse-tags placeholder="请选择 Gadgets" slot="prepend" style="width: 150px; background-color: #409EFF;">
                <el-option
                  v-for="item in options"
                  :key="item.value"
                  :label="item.label"
                  :value="item.value">
                </el-option>
            </el-select>
          </el-input>
          <el-input placeholder="Get Ceye Domain" v-model="domain" style="width: 220px;">
               <el-button slot="append" icon="el-icon-search" @click="getDomain"></el-button>
           </el-input>
          <el-button type="danger" icon="el-icon-s-promotion" circle style="float: right;" @click="select"></el-button>

              <el-table
                v-loading="tableLoading"
                :element-loading-text="content"
                element-loading-spinner="el-icon-loading"
                element-loading-background="rgba(0, 0, 0, 0.8)"
                :data="tableData"
                height="250"
                border
                style="width: 100%; margin-top: 20px;">

                <el-table-column
                  prop="id"
                  label="ID"
                  width="150">
                </el-table-column>
                <el-table-column
                  prop="name"
                  label="Name"
                  width="250">
                  <template slot="header" slot-scope="scope">
                    Name
                    <el-button size="small" circle icon="el-icon-delete-solid" @click="tableData=[]" style="float: right;"></el-button>
                  </template>
                </el-table-column>
                <el-table-column
                  prop="remote_addr"
                  label="Remote Addr">
                </el-table-column>
                <el-table-column
                  prop="created_at"
                  width="180">
                  <template slot="header" slot-scope="scope">
                    Created At (UTC)
                    <el-button size="small" circle icon="el-icon-refresh-right" @click="getCeyeData" style="float: right;"></el-button>
                  </template>
                </el-table-column>


              </el-table>

        </el-card>
      </el-col>

      <el-col :span="6">
        <el-card style="width: 500px; height: 600px; overflow-y: scroll; background-color: #EBEEF5;">
          <div>
            <strong>Check Result:</strong>
            <el-button type="danger" icon="el-icon-delete" circle style="float: right;" @click="clear"></el-button>
          </div>
          <p v-for="result in checkResults">
            {{result}}
          </p>
          <p v-if="isFindKey" style="color: red;">[=] Result is: {{validKey}}</p>
          <i class="el-icon-time" v-if="analyse">{{content}}</i>
        </el-card>
      </el-col>
    </el-row>
  </div>
</template>

<script>
  export default {
    name: 'Main',
    data: function() {
      return {
        checked: false,
        tableLoading: false,

        isView: true,

        domain: '',
        randomId: '',

        dialogVisible: false,

        websocket: true,
        url: '',

        content: '正在统计结果:',
        totalTime: 18,
        analyse: false,

        isFindKey: false,

        loading: false,
        key:'',
        validKey:'',
        validGadgets:[],
        checkResults: [],
        cmd: '',
        options: [{
                  value: 'CommonsCollections1',
                  label: 'CC1'
                }, {
                  value: 'CommonsCollections2',
                  label: 'CC2'
                }, {
                  value: 'CommonsCollections3',
                  label: 'CC3'
                }, {
                  value: 'CommonsCollections4',
                  label: 'CC4'
                }, {
                  value: 'CommonsCollections5',
                  label: 'CC5'
                }, {
                  value: 'CommonsCollections6',
                  label: 'CC6'
                }, {
                  value: 'CommonsCollections7',
                  label: 'CC7'
                }, {
                  value: 'CommonsCollections8',
                  label: 'CC8'
                }, {
                  value: 'CommonsCollections9',
                  label: 'CC9'
                }, {
                  value: 'CommonsCollections10',
                  label: 'CC10'
                }, {
                  value: 'Jdk7u21',
                  label: 'Jdk7u21'
                }, {
                  value: 'Hibernate1',
                  label: 'Hibernate1'
                }, {
                  value: 'Hibernate2',
                  label: 'Hibernate2'
                }, {
                  value: 'Spring1',
                  label: 'Spring1'
                }, {
                  value: 'Spring2',
                  label: 'Spring2'
                }, {
                  value: 'Spring3',
                  label: 'Spring3'
                }, {
                  value: 'Myfaces1',
                  label: 'Myfaces1'
                }, {
                  value: 'Myfaces2',
                  label: 'Myfaces2'
                }, {
                  value: 'C3P0',
                  label: 'C3P0'
                }, {
                  value: 'Clojure',
                  label: 'Clojure'
                }, {
                  value: 'FileUpload1',
                  label: 'FileUpload1'
                }, {
                  value: 'Groovy1',
                  label: 'Groovy1'
                }, {
                  value: 'BeanShell1',
                  label: 'BeanShell1'
                }, {
                  value: 'JBossInterceptors1',
                  label: 'JBossInterceptors1'
                }, {
                  value: 'JSON1',
                  label: 'JSON1'
                }, {
                  value: 'JavassistWeld1',
                  label: 'JavassistWeld1'
                }, {
                  value: 'Jython1',
                  label: 'Jython1'
                }, {
                  value: 'MozillaRhino1',
                  label: 'MozillaRhino1'
                }, {
                  value: 'MozillaRhino2',
                  label: 'MozillaRhino2'
                }, {
                  value: 'ROME',
                  label: 'ROME'
                }, {
                  value: 'Vaadin1',
                  label: 'Vaadin1'
                }, {
                  value: 'Wicket1',
                  label: 'Wicket1'
                }
                ],
        value1: [],
        value2: [],
        tableData: []
      }
    },
    created:function(){
      this.initWebSocket()
    },
    methods: {
      select: function() {
        this.clear()
        if(this.cmd.indexOf("ceye.io")!=-1 || this.cmd.indexOf("bash")!=-1){
          this.tableLoading = true
          this.countDownTable()
        }
        this.$axios.post('/exploit', {payloadList:this.value1, cmd:this.cmd, key:this.key, url:this.url})
      },
      check: function() {
        this.clear()
        this.loading = true
        this.$axios.get('/check?url=' + this.url)
      },
      checkGadget: function() {
        this.clear()
        this.$axios.post('/hello', {payloadList:this.value2, cmd:'', key:this.key, url:this.url})
      },
      initWebSocket: function() {

        let wPath = window.document.location.href
        let pathName =  this.$route.path
        let pos = wPath.indexOf(pathName)
        let localhostPath = wPath.substring(0, pos)

        var substring1 = "https";
        var substring2 = "http";

        if(localhostPath.includes(substring1)){
          localhostPath = localhostPath.replace('https','ws')
        }
        if(localhostPath.includes(substring2)){
          localhostPath = localhostPath.replace('http','ws')
        }

        // localhostPath 获取后端服务器的 ip 与端口，并将 http/https 协议换为 ws 协议

        this.websock = new WebSocket( localhostPath+"/websocket" )
        this.websock.onopen = this.websockonopen
        this.websock.onerror = this.websockonerror
        this.websock.onmessage = this.websockonmessage
        this.websock.onclose = this.websockonclose
      },

      websockonopen: function(){
        this.$notify({
          title: 'websock成功',
          message: 'websock连接成功',
          type: 'success'
        })
      },
      websockonerror: function(){
        this.$notify({
          title: 'websock失败',
          message: 'websock连接失败',
          type: 'error'
        })
      },
      websockonmessage: function(msg){
        this.checkResults.push(msg.data)
        if(msg.data.indexOf("[+] Find key")!=-1) {
          this.loading = false
          this.isFindKey = true
          this.validKey = msg.data.replace("[+] Find key: ","")
        }
        if(msg.data.indexOf("[%] Analyse...")!=-1) {
          this.analyse = true
          this.countDown()
        }
        if(msg.data.indexOf("[+] Find Gadget:")!=-1) {
          var temp = msg.data.replace("[+] Find Gadget: ","")
          this.validGadgets.push(temp)
        }
      },
      websockonclose: function(){
        this.websocket = false
        this.$notify({
          title: 'websock关闭',
          message: 'websock连接关闭',
          type: 'warning'
        })
      },
      mulWebSocket: function() {
        if(this.websocket) {
          this.initWebSocket()
        }
        else {
          this.websock.close()
        }
      },
      clear: function() {
        this.validGadgets = []
        this.isFindKey = false
        this.isView = true
        this.checkResults = []
      },
      countDown: function() {
        let clock = window.setInterval(() => {
              this.totalTime--
              this.content ='倒计时' + this.totalTime + 's'
              if (this.totalTime < 0) {     //当倒计时小于0时清除定时器
                window.clearInterval(clock)
                this.content = ''
                this.totalTime = 18
                this.analyse = false
                this.isView = false
                this.tableLoading = false
                }
            },1000)
      },
      countDownTable: function() {
        this.totalTime = 18
        let clock = window.setInterval(() => {
              this.totalTime--
              this.content ='倒计时' + this.totalTime + 's'
              if (this.totalTime < 0) {     //当倒计时小于0时清除定时器
                window.clearInterval(clock)
                this.content = ''
                this.totalTime = 18
                this.tableLoading = false
                this.getCeyeData()
                }
            },1000)
      },
      getCeyeData: function() {
        this.$axios.get('/ceye?id='+this.randomId)
                   .then( s_resp => {
                     this.tableData = s_resp.data.data
                   })
      },
      getDomain: function() {
        this.$axios.get('/domain')
                   .then( s_resp => {
                     var temp = s_resp.data
                     this.domain = temp
                     this.randomId = temp.split('.')[0]
                   })
      },
      selectAll: function() {
        this.value2 = []
        if (this.checked) {
          this.value2 = []
          this.options.map( (item) =>{
            this.value2.push(item.value)
          })
        } else {
          this.value2 = []
        }
      },
      changeSelect: function(val) {
        if (val.length === this.options.length) {
                this.checked = true
              } else {
                this.checked = false
              }
      }
    }

  }
</script>

<style>
  .el-checkbox {
      text-align: right;
      width: 100%;
    }
</style>
